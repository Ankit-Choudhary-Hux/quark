// pacakge interop {

    interface ClientCheck {
        void check(TimeoutClient client);
    }

    interface ResponseCheck {
        void checkResponse(HTTPResponse response);
    }

    class ClientResponseCheck extends ClientCheck, ResponseCheck {
        void check(TimeoutClient client) {
            if (client.response != null) {
                self.checkResponse(client.response);
            } else {
                print("FAIL: No response");
            }
        }
    }

    interface RequestCheck {
        void checkRequest(HTTPRequest request);
    }

    class CheckCode extends ResponseCheck {
        int expected;
        CheckCode(int code) {
            self.expected = code;
        }
        void checkResponse(HTTPResponse response) {
            int actual = response.getCode();
            if (actual != expected) {
                print("FAIL: Response code " + actual.toString() + " expected " + expected.toString());
            } else {
                print("OK: Response code " + actual.toString());
            }
        }
    }

    class ClientResponseCheckCode extends CheckCode, ClientResponseCheck {}

    class CheckBody extends ResponseCheck {
        String expected;
        CheckBody(String body) {
            self.expected = body;
        }
        void checkResponse(HTTPResponse response) {
            String actual = response.getBody();
            if (actual != expected) {
                print("FAIL: Response body " + actual + " expected " + expected);
            } else {
                print("OK: Response body " + actual);
            }
        }
    }

    class ClientResponseCheckBody extends CheckBody, ClientResponseCheck {}

    class Headers<T> {
        T thing;
        String name;
        Headers(T thing, String name) { self.thing = thing; self.name = name; }
        macro String getHeader(String key) self.thing.getHeader(key);
        macro List<String> getHeaders() self.thing.getHeaders();
    }

    class CheckHeader<T> extends ResponseCheck {
        String key;
        String expected;
        CheckBody(String key, String value) {
            self.key = key;
            self.expected = value;
        }
        void checkHeader(Headers<T> thing) {
            String actual = thing.getHeader(self.key);
            if (actual != expected) {
                if (actual == null) {
                    print("FAIL: missing header " + self.key +
                          " in " + thing.name + " headers: " +
                          ", ".join(thing.getHeaders()));
                } else {
                    print("FAIL: " + thing.name + " header " + self.key + ": " + actual + " expected " + expected);
                }
            } else {
                print("OK: " + thing.name + " header " + self.key + ": " + actual);
            }
        }
    }

    class CheckRequestHeader extends CheckHeader<HTTPRequest>, RequestCheck {
        void checkRequest(HTTPRequest request) {
            self.checkHeader(Headers<HTTPRequest>(request), "request");
        }
    }


    class CheckResponseHeader extends CheckHeader<HTTPResponse>, ResponseCheck {
        void checkResponse(HTTPResponse response) {
            self.checkHeader(Headers<HTTPResponse>(response), "response");
        }
    }

    class ClientResponseCheckHeader extends CheckResponseHeader, ClientResponseCheck {}

    class Timeout extends Task {
        bool timedOut;
        bool cancelled;
        Timeout() {
            self.timedOut = false;
            self.cancelled = false;
        }
        void cancel() {
            if (self.timedOut) {
                return;
            } else {
                self.cancelled = true;
            }
        }
        void onExecute(Runtime runtime) {
            if (self.cancelled) {
                return;
            } else {
                self.timedOut = true;
            }
        }
    }

    class TimeoutClient extends HTTPHandler {
        bool timedOut;
        HTTPRequest request;
        HTTPResponse response;
        Runtime runtime;
        String prefix;
        List<ClientCheck> expectations;
        Timeout timeout;
        TimeoutClient(Runtime runtime, int port) {
            self.runtime = runtime;
            self.prefix = "http://127.0.0.1:" + port.toString();
            self.timedOut = false;
            self.expectations = new List<ClientCheck>();
        }
        TimeoutClient url(String path) {
            self.request = HTTPRequest(self.prefix + path);
            return self;
        }
        TimeoutClient expectCode(int code) {
            self.expectations.add(ClientResponseCheckCode(code));
            return self;
        }
        TimeoutClient expectBody(String body) {
            self.expectations.add(ClientResponseCheckBody(body));
            return self;
        }
        TimeoutClient expectHeader(String key, String value) {
            self.expectations.add(ClientResponseCheckHeader(key, value));
            return self;
        }
        void check(float timeout) {
            self.timeout = Timeout();
            self.response = null;
            if (self.request != null) {
                self.runtime.schedule(self.timeout, timeout);
                self.runtime.request(self.request, self);
            } else {
                print("FAIL: cannot check without request");
            }
        }
        void onHTTPInit(HTTPRequest request) {
            print("onHTTPInit " + request.getUrl());
        }
        void onHTTPError(HTTPRequest request) {
            print("onHTTPError " + request.getUrl());
        }
        void onHTTPFinal(HTTPRequest request) {
            print("onHTTPFinal " + request.getUrl());
        }
        void onHTTPResponse(HTTPRequest request, HTTPResponse response) {
            self.timeout.cancel();
            if (self.timeout.timedOut) {
                print("FAIL: too late response");
                return;
            }
            self.response = response;
            int i = 0;

            while (i < self.expectations.size()) {
                self.expectations[i].check(self);
                i = i + 1;
            }
        }
    }

// }
